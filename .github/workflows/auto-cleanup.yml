name: Auto Delete Old Workflow Runs

on:
  workflow_dispatch:

jobs:
  delete-old-runs:
    runs-on: ubuntu-latest
    permissions:
      actions: write  # gh run delete 에 필요
    steps:
      - name: Install GitHub CLI
        run: |
          curl -fsSL https://github.com/cli/cli/releases/download/v2.37.0/gh_2.37.0_linux_amd64.tar.gz -o gh.tar.gz
          tar -xzf gh.tar.gz
          sudo cp gh_2.37.0_linux_amd64/bin/gh /usr/local/bin/gh

      - name: Delete old workflow runs (only for specific workflow name)
        env:
          GH_REPO: ${{ github.repository }}
        run: |
          WORKFLOW_NAME="Send Discord Webhook Every 30 Minutes"

          echo "Getting workflow ID for: $WORKFLOW_NAME"
          WORKFLOW_ID=$(gh workflow list --repo "$GH_REPO" --limit 100 --json name,id --jq ".[] | select(.name==\"$WORKFLOW_NAME\") | .id")

          if [ -z "$WORKFLOW_ID" ]; then
            echo "❌ Workflow not found: $WORKFLOW_NAME"
            exit 1
          fi

          echo "🧹 Deleting runs older than 3 days for workflow ID: $WORKFLOW_ID"

          gh run list --workflow "$WORKFLOW_ID" --limit 100 --json databaseId,createdAt --jq '.[] | select((now - (.createdAt | fromdateiso8601)) > (3*24*60*60)) | .databaseId' |
          while read -r run_id; do
            echo "Deleting run: $run_id"
            gh run delete "$run_id" --yes
          done
